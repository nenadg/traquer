"use strict";var Traquer=function(){if(!(this instanceof Traquer)){return new Traquer()}this.index=0;this.logging=false;this.recordedEvents=[];this.previousElement=null;this.domWatchCounter=0;this.eventNames=["mousemove","mouseenter","mouseleave","mouseover","mousedown","mouseup","mouseout","click","scroll","contextmenu","wheel","focus","focusin","focusout","change","input","textinput","keypress","keydown","keyup","DOMFocusIn","DOMFocusOut","selectstart","selectionchange","select","DOMActivate"];var a=document.querySelector(".traquer-base");if(!a){a=document.createElement("div");a.className="traquer-base";document.body.appendChild(a);window.onerror=function(d,c,b){var e=new Event("traquerfail");e.details=[d,c,b];a.dispatchEvent(e)};a.addEventListener("traquerfail",function(b){console.log("[e] Event execution failed.");console.log(b)});a.addEventListener("traquerwarn",function(b){console.warn("[e] Event execution warning.");console.log(b)})}Traquer.__instance=this};Traquer.getInstance=function(){return this.__instance};Traquer.prototype={getId:function(){var b=this.recordedEvents,a="e_"+Math.random().toString(36).substring(3).substr(0,8);if(b&&b.length){var c=b.filter(function(d){if(d.tid==a){return a}});if(c.length){a=this.getId()}}return a},isEventObservable:function(a){if(a&&a.type){return this.eventNames.indexOf(a.type)>-1}return false},start:function(b){var a=this;a.isRecording=true;a.recordingStartTime=new Date().getTime();a.recordedEvents=[];a.mousePosition={x:0,y:0};var c=a.eventNames||[];a.processEventBinded=a.processEvent.bind(a);c.forEach(function(d){document.body.addEventListener(d,a.processEventBinded,false)});document.addEventListener("mousemove",function(d){a.mousePosition.x=d.clientX;a.mousePosition.y=d.clientY});document.addEventListener("DOMSubtreeModified",a.domWatch);if(b){this.logging=true}},stop:function(){var a=this;var c=a.eventNames||[];if(a.processEventBinded){c.forEach(function(d){document.body.removeEventListener(d,a.processEventBinded,false)})}a.isRecording=false;if(a.playerTarget){var b=new Event("stop");a.playerTarget.dispatchEvent(b)}document.removeEventListener("DOMSubtreeModified",a.domWatch,false);return this.recordedEvents},copyEventObject:function(a){var d={};for(var b in a){var c=typeof a[b];if(c!="function"&&c!="object"){d[b]=a[b]}}return d},createTrackingObject:function(a){var b=this;return{tid:b.getId(),index:b.index,x:b.mousePosition.x,y:b.mousePosition.y,time:new Date().getTime()-b.recordingStartTime,raw:b.copyEventObject(a),type:a.type,id:a.target.id,targetType:a.target.tagName?a.target.tagName.toLowerCase():null,value:encodeURIComponent(a.target.value||a.target.text),attrs:b.getAttributes(a.target),classList:b.getClassess(a.target)}},processEvent:function(b){var d=this;if(b.type=="mousedown"){d.isMouseDown=true}if(d.isEventObservable(b)||d.isMouseDown){var c=d.createTrackingObject(b);if(c.id!="traquer-recorder"&&c.id!="traquer-player"&&c.id!="traquer-reset"){var a=d.createSelector.call(c,d),e=document.querySelector(a);if(e){c.selector=d.createXPathFromElement(e);delete c.classList;delete c.attrs;d.domWatchCounter=0;d.recordedEvents.push(c);this.index++;if(this.logging){console.log(c)}}}}if(b.type=="mouseup"){d.isMouseDown=false}},eventsScheduler:function(){var c=this;if(c.eventsInfo&&c.eventsEmitted<c.eventsInfo.length){var e=c.eventsInfo[this.eventsEmitted];var b=c.eventsInfo[this.eventsEmitted-1];var a=b?e.time-b.time:e.time;var d=setTimeout(function(){c.eventEmitter(e);c.eventsEmitted++;c.eventsScheduler();clearTimeout(d)},a)}else{c.isPlaying=false;c.removeFakeCursor()}},play:function(b){if(this.isPlaying){return}var a=this.getSimilarity(b);if(a<50){console.warn("[w] Current scenario is less than 50% similar to page you`re testing ("+a+")")}this.isPlaying=true;this.createFakeCursor();this.eventsEmitted=0;this.eventsInfo=b;this.eventsScheduler()},domWatch:function(a){var c=Traquer.getInstance(),b=c.createTrackingObject(a);if(c.domWatchCounter>100){delete b.classList;delete b.attrs;c.domWatchCounter=0;c.recordedEvents.push(b)}else{c.domWatchCounter++}},eventEmitter:function(i){var l=this;if(i){var j=l.lookupElementByXPath(i.selector),h=l.getFakeCursor(),k=new Traquer.EventBase(l);h.style.top=i.y+"px";h.style.left=i.x+"px";if(!j){j=document.elementFromPoint(i.x,i.y);console.log("");console.warn("[f] lookupElementByXPath failed, will use elementFromPoint, details: ");console.warn("[|-->] failed     : ",i.selector);console.warn("[|-->] from point : ",l.createXPathFromElement(j));if(!j){console.error("[f] nothing found.");return}}if(!this.previousElement){this.previousElement=j.parentElement}else{var b=this.matchChild(this.previousElement,j);var e=this.getOffset(this.previousElement);var c=this.getOffset(j);var g={x1:e.x,x2:e.x+e.w,y1:e.y,y2:e.y+e.h};var d=this.pointRectangleIntersection(c,g);if(d||b){i.stopPropagationFlag=true}this.previousElement=null}var f;i.value=i.value?decodeURIComponent(i.value):i.value;switch(i.type){case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mousedown":case"mouseup":case"mouseout":case"click":case"dblclick":case"contextmenu":k.mouseEvents(i,j);break;case"wheel":k.wheelEvents(i,j);break;case"DOMFocusIn":case"DOMFocusOut":case"focusin":case"focus":case"focusout":case"blur":k.focusEvents(i,j);break;case"beforeinput":case"input":case"textinput":k.inputEvents(i,j);break;case"keypress":case"keydown":case"keyup":case"nothing":k.keyEvents(i,j);break;case"change":k.event(i,j);break;case"selectstart":case"selectionchange":k.focusEvents(i,j);break;case"scroll":case"select":case"DOMMouseScroll":case"DOMActivate":case"DOMSubtreeModified":case"DOMCharacterDataModified":k.UIEvents(i,j);break}if(l.trackTarget){var a=new CustomEvent("move",{detail:{eventInfo:i,last:l.recordedEvents[l.recordedEvents.length-1].time}});l.trackTarget.dispatchEvent(a)}}if(l.recordedEvents.indexOf(i)==l.recordedEvents.length-1){console.log("Stopping.");l.stop()}},getFakeCursor:function(){return this.fakeCursor||this.createFakeCursor()},createFakeCursor:function(){this.fakeCursor=document.createElement("div");this.fakeCursor.style.height="10px";this.fakeCursor.style.width="10px";this.fakeCursor.style.background="red";this.fakeCursor.style.opacity="0.5";this.fakeCursor.style.display="block";this.fakeCursor.style.position="fixed";this.fakeCursor.style.borderRadius="10px";this.fakeCursor.style.zIndex="2147483647";this.fakeCursor.style.border="1px solid red";document.body.appendChild(this.fakeCursor)},removeFakeCursor:function(){if(this.fakeCursor){document.body.removeChild(this.fakeCursor);delete this.fakeCursor}},toggleStopPropagation:function(c,a){var b=["mouseover","mouseenter","mouseleave","mouseout"];if(c.stopPropagationFlag&&b.indexOf(c.type)>-1){a.stopPropagation()}},getAttributes:function(d){var a=[],c;for(c in d.attributes){if(d.attributes.hasOwnProperty(c)){if(d.attributes[c].name!=="style"&&d.attributes[c].value){var h=d.attributes[c].value.match(/<.*?[\s\S]*?>[\s\S]*?<\/.*>/g),e=d.attributes[c].value.match(/(http:).*/g),b=d.attributes[c].name.match(/data-.*/g),g=d.attributes[c].name=="id";if(!g&&(h==null)&&(e==null)&&(b==null)){var f=d.attributes[c].name+'="'+d.attributes[c].value+'"';a.push(f)}}}}return a},getClassess:function(c){var b=[],a;for(a in c.classList){if(c.classList.hasOwnProperty(a)){b.push(c.classList[a])}}return b},ignoredAttributes:["select","over","dirty","href","valign","role","tabindex","over","dirty","focus","active","pressed"],matchIgnored:function(b){var a=this;return !!a.ignoredAttributes.map(function(c){if(b.indexOf(c)>-1){return c}}).filter(function(d){if(d){return d}}).length},getSelector:function(b,g,f,h){var a=this,e="";if(b.length){var c;for(c in b){if(b.hasOwnProperty(c)){if(b[c]==="value"){e+="["+b[c]+'="'+f+'"]'}else{if(b[c]!==undefined){var d=a.matchIgnored(b[c]);if(!d){e+="["+b[c]+"]"}}}}}}if(g.length){var c;for(c in g){if(g.hasOwnProperty(c)){var d=a.matchIgnored(g[c]);if(!d){e+="."+g[c]}}}}if(h){e+="#"+h}return e},createSelector:function(e){var i=this,b=[],c=i.targetType+e.getSelector(i.attrs,i.classList,i.value,i.id),f=Array.prototype.slice.call(document.querySelectorAll(c)),h=f.filter(function(j){var l=j.getBoundingClientRect(),k={height:50,left:e.mousePosition.x,top:e.mousePosition.y,width:50},m=e.getIntersection(j,k);if(m){return j}})[0];if(!h){return c}var g=e.getAttributes(h),d=e.getClassess(h),a=e.getSelector(g,d,h.value,h.id);c=a&&a.length?a:c;return c},createXPathFromElement:function(h){var j=this,a=document.getElementsByTagName("*");for(var b=[];h&&h.nodeType==1;h=h.parentNode){if(h.hasAttribute("id")){var f=0;for(var e=0;e<a.length;e++){if(a[e].hasAttribute("id")&&a[e].id==h.id){f++}if(f>1){break}}if(f==1){b.unshift('id("'+h.getAttribute("id")+'")');return b.join("/")}else{b.unshift(h.localName.toLowerCase()+'[@id="'+h.getAttribute("id")+'"]')}}else{if(h.hasAttribute("class")){var c=h.getAttribute("class");if(j.matchIgnored(c)){c=c.split(" ");c=c.filter(function(i){if(!j.matchIgnored(i)){return i}});c=c.join(" ")}b.unshift(h.localName.toLowerCase()+'[@class="'+c+'"]')}else{for(var g=1,d=h.previousSibling;d;d=d.previousSibling){if(d.localName==h.localName){g++}}b.unshift(h.localName.toLowerCase()+"["+g+"]")}}}return b.length?"/"+b.join("/"):null},lookupElementByXPath:function(b){var c=new XPathEvaluator();var a=c.evaluate(b,document.documentElement,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);return a.singleNodeValue},getIntersection:function(e,a){var d=e.getBoundingClientRect();var c=a.getBoundingClientRect?a.getBoundingClientRect():a;var b=false;if((d.left<=(c.left+c.width)&&(c.left<=(d.left+d.width)))&&(d.top<=(c.top+c.height))&&(c.top<=(d.top+d.height))){b=true}return b},getOffset:function(d){var f=d.getBoundingClientRect(),a=f.left,e=f.top,b=f.width,c=f.height;return{x:a,y:e,w:b,h:c}},pointRectangleIntersection:function(b,a){return b.x>a.x1&&b.x<a.x2&&b.y>a.y1&&b.y<a.y2},matchChild:function(b,e){var c=false,a;if(b&&b.childNodes){for(a in b.childNodes){if(b.childNodes.hasOwnProperty(a)){var d=b.childNodes[a];if(d==e){return true}else{this.matchChild(d,e)}}}}return c},getSimilarity:function(c){var a=0,j=0,d=false,f;for(f in c){if(c.hasOwnProperty(f)){var h=c[f],e=this.lookupElementByXPath(h.selector);if(h.type=="DOMSubtreeModified"){d=!d}if(d){a++;continue}if(e&&!d){var b=window.getComputedStyle(e),g=b.visibility=="hidden";if(!g){a++}}}}j=(a/c.length)*100;return Math.round(j*100)/100},replaceHtml:function(el,html){var oldEl=typeof el==="string"?document.getElementById(el):el;
/*@cc_on // Pure innerHTML is slightly faster in IE
            oldEl.innerHTML = html;
            return oldEl;
        @*/
var newEl=oldEl.cloneNode(false);newEl.innerHTML=html;oldEl.parentNode.replaceChild(newEl,oldEl);return newEl}};"use strict";Traquer.Controls=function(){if(!(this instanceof Traquer.Controls)){return new Traquer.Controls()}this.traquer=Traquer.getInstance();this.styles=["base.css","timeline.css","recorder.css","player.css","reset.css","track.css","editor.css","storage.css","modal.css","heatmap.css"];Traquer.Controls.__instance=this};Traquer.Controls.getInstance=function(){return this.__instance};Traquer.Controls.prototype.loadStyles=function(){var j=this,d=j.traquer,c=d.config,g=document.head,h=g.querySelectorAll("link"),f=false,e;for(e in h){if(h.hasOwnProperty(e)){var b=h[e];if(j.styles.indexOf(b.href)>-1){f=true}}}if(!f){console.warn("[i] load min styles.");var a=document.createElement("link");a.rel="stylesheet";a.type="text/css";a.href=c.host+"/traquer.min.css";document.head.appendChild(a)}};Traquer.Controls.prototype.recording=function(d,g){var c=d,a=c.traquer,b=g.target,f=document.querySelector(".traquer-player");if(!a.isRecording){a.start();b.className="traquer-recorder squared";return}if(f){document.body.removeChild(f)}b.className="traquer-recorder";a.stop();var h=new Traquer.Storage();h.save(a.recordedEvents);c.timeline.call(c);c.player.call(c)};Traquer.Controls.prototype.timeline=function(){var n=this,s=n.traquer,b=s.recordedEvents,a=document.querySelector("ol.traquer-timeline-container");var f=performance.now();if(!a){a=document.createElement("ol");a.className="traquer-timeline-container";document.body.appendChild(a)}a.innerHTML="";if(!b.length){return}var h=a.getBoundingClientRect(),l=h.width,j=b[b.length-1].time;n.tlcWidth=l;var t=2147000000,u=[],g="",d,p;for(p in b){if(b.hasOwnProperty(p)){var o=b[p],r=parseInt(o.time/j*100),e=parseInt(r*l/100),m=o.tid,q=['<li id="'+m+'"',' style="left: '+e+'px;"',' class="{css-class}">','<div class="tl-type" style="z-index: '+(t++)+'">',"{title} {key} ","</div>",'<div class="tl-selector" style="z-index: '+(t++)+'">',"{selector}","</div>","</li>"].join("");var k=o.type=="click"||o.type=="keydown"||o.type=="keyup"||o.type=="keypress"?"red":o.type.indexOf("DOM")>-1?"blue":o.type.indexOf("select")>-1?"green":"default";q=q.replace(/{title}/igm,o.type).replace(/{selector}/igm,o.selector).replace(/{key}/igm,o.raw.key||"").replace(/{css-class}/igm,k);var c={id:m,time:o.time,type:o.type,lastTimeLine:e,selector:o.selector};u.push(c);g+=q}}a=s.replaceHtml(a,g);n.addTimeLineEvents(u,d,j,l);console.log("now",performance.now()-f)};Traquer.Controls.prototype.addTimeLineEvents=function(y,b,j,l){var q=this,t,x=q.traquer,a=[];for(t=0;t<y.length;t++){var c=y[t],e=c.type,r=c.id,h=c.time,s=c.selector,w=parseInt(h/j*100),d=parseInt(w*l/100),m=document.getElementById(r);if(b&&(d>b-10&&d<b+10)){var u=m.previousSibling;if(!u){continue}var n=m.getAttribute("data-top")||window.getComputedStyle(m).top,v=u.getAttribute("data-top")||window.getComputedStyle(u).top,f=Math.abs(Math.round(parseFloat(n.replace("px",""))*100/100)),p=Math.abs(Math.round(parseFloat(v.replace("px",""))*100/100)),o=0;if((e=="click"||e=="keydown"||e=="keyup"||e=="keypress"||e.indexOf("DOM")>-1||e.indexOf("select")>-1)){if(p==f){o=f+8}if(p>f){o=p-f+4}if(p<f){o=f-p+4}o=-o;o+="px"}else{if(p==f){o+=f+8}if(p>f){o+=p-f+38}if(p<f){o+=f-p+38}o-=70;o+="px"}m.setAttribute("data-top",o);var g=".style-for-"+r+"{top:"+o+"!important;}\n";a.push(g)}m.addEventListener("click",function(z,H,C,D,G){var B=this.recordedEvents.filter(function(i){return i.tid==z})[0];var I=G.target,A=I.parentNode.querySelectorAll(".selected"),F;for(F in A){if(A.hasOwnProperty(F)){var E=A[F];E.className=E.className.replace("selected","")}}if(I.className.indexOf("selected")==-1){I.className+=" selected"}else{I.className=I.className.replace("selected","")}q.editor(z,H,C,D)}.bind(x,r,e,h,s));b=c.lastTimeLine}var k=a.join("");q.appendInnerStyles(k,y)};Traquer.Controls.prototype.appendInnerStyles=function(e,d){var c=document.querySelector("#traquer-inline-styles"),b;if(!c){c=document.createElement("style");c.type="text/css";c.id="traquer-inline-styles";c.appendChild(document.createTextNode(e));document.getElementsByTagName("head")[0].appendChild(c)}else{c.innerText="";c.appendChild(document.createTextNode(e))}for(b=0;b<d.length;b++){var g=d[b],f=g.id,a=document.getElementById(f);a.className+=" style-for-"+f;a.removeAttribute("data-top")}};Traquer.Controls.prototype.player=function(){var b=this,a=b.traquer,e=a.recordedEvents,f=document.querySelector("ol.traquer-timeline-container"),d=document.querySelector(".traquer-timeline-track"),c=document.querySelector(".traquer-player");if(!c){c=document.createElement("div");c.className="traquer-player";c.title="Replay";document.body.appendChild(c);c.innerHTML='<div class="play"></div>';a.playerTarget=c;c.addEventListener("stop",function(g){c.className="traquer-player"});c.addEventListener("click",function(h,j){var g=this;if(!g.isPlaying){c.className+=" playing";g.play(h);var i=document.querySelector(".traquer-editor");if(i){document.body.removeChild(i)}return}g.stop();c.className="traquer-player"}.bind(a,e))}this.reset();if(!d){d=document.createElement("div");d.className="traquer-timeline-track";d.draggable=true;document.body.appendChild(d);d.innerHTML=['<div class="current-event">',"</div>"].join("");a.trackTarget=d;d.addEventListener("move",function(m){var k=m.detail.eventInfo,j=m.detail.last,l=k.time,g=b.tlcWidth,i=document.querySelector(".current-event");var n=parseInt(l/j*100),h=parseInt(n*g/100)+152;m.target.style.cssText="left: "+h+"px;";if(b.previousTime>l-2&&b.previousTime<l+2){i.innerHTML+=k.type+"("+l+") <br />"}else{i.innerHTML=k.type+"("+l+") <br />"}b.previousTime=l})}};Traquer.Controls.prototype.reset=function(){var b=this,a=b.traquer,c=a.recordedEvents,d=document.querySelector(".traquer-reset");if(!d){d=document.createElement("div");d.className="traquer-reset";d.title="Reset";document.body.appendChild(d);d.innerHTML='<div class="play"></div>';d.addEventListener("click",function(j,l){var f=this,m=document.querySelector("ol.traquer-timeline-container"),i=document.querySelector(".traquer-timeline-track"),h=document.querySelector(".current-event"),g=document.querySelector(".traquer-player"),k=document.querySelector(".traquer-editor");f.recordedEvents=[];document.body.removeChild(g);document.body.removeChild(d);document.body.removeChild(m);document.body.removeChild(i);if(k){document.body.removeChild(k)}}.bind(a,c))}};Traquer.Controls.prototype.editor=function(a,g,b,c){var i=this,d=i.traquer,h=d.recordedEvents,f=document.querySelector(".traquer-editor");if(!f){f=document.createElement("div");f.className="traquer-editor";document.body.appendChild(f)}var e=['<h3>Event `<span id="event-type-'+a+'">'+g+"</span>`</h3>",'<span id="editor-close" class="close">x</span>',"<p>Event executed at "+b+"ms from start.</p>",'<p class="editor-event-selector">Selector:<br/>','<i id="event-selector-'+a+'" class="selector">'+c+"</i>","</p>",'<p id="delete-event-'+a+'" class="button red">Delete event</p>','<p id="edit-event-'+a+'" class="button">Edit event</p>'].join("");f.innerHTML="";f.innerHTML=e;this.bindDelete(f.querySelector("#delete-event-"+a),a);this.bindEdit(f.querySelector("#edit-event-"+a),a);this.bindClose(f.querySelector("#editor-close"))};Traquer.Controls.prototype.bindClose=function(b){var a=this;b.addEventListener("click",function(d){var c=document.querySelector(".traquer-editor");document.body.removeChild(c);a.timeline.call(a)})};Traquer.Controls.prototype.bindDelete=function(d,e){var b=this,a=b.traquer,c=a.recordedEvents;d.addEventListener("click",function(h){var f=c.filter(function(i){return i.tid==e})[0],g=document.querySelector(".traquer-editor");c.splice(c.indexOf(f),1);b.timeline.call(b);document.body.removeChild(g)})};Traquer.Controls.prototype.bindEdit=function(b,c){var a=this;b.addEventListener("click",a.editFn.bind(a,b,c))};Traquer.Controls.prototype.editFn=function(c,a,j){var m=this,g=m.traquer,l=g.recordedEvents,b=l.filter(function(e){return e.tid==a})[0],h=document.querySelector(".traquer-editor"),d=document.querySelector("#delete-event-"+a),f=document.querySelector("#event-type-"+a),i=document.querySelector("#event-selector-"+a);c.removeEventListener("click",m.editFn,false);if(d){h.removeChild(d)}f.setAttribute("contentEditable",true);i.setAttribute("contentEditable",true);var k=c.cloneNode();k.id="save-event-"+a;k.innerText="Save";k.className+=" green";k.addEventListener("click",m.saveFn.bind(m,c,a));h.replaceChild(k,c)};Traquer.Controls.prototype.saveFn=function(c,b,j){var m=this,h=m.traquer,l=h.recordedEvents,f=document.querySelector("#event-type-"+b),k=document.querySelector("#event-selector-"+b),i=document.querySelector(".traquer-editor"),a=l.filter(function(e){return e.tid==b})[0],d=f.innerText,g=k.innerText;a.type=d&&d.length?d.replace(/\s/g,""):a.type;a.selector=g&&g.length?g:a.selector;l[l.indexOf(a)]=a;m.timeline.call(m);document.body.removeChild(i)};"use strict";Traquer.EventBase=function(a){if(!(this instanceof Traquer.EventBase)){return new Traquer.EventBase()}if(!a||!(a instanceof Traquer)){throw new Error("Can't instantiate EventBase without Traquer instance!")}this.traquer=a};Traquer.EventBase.prototype={getScrollTarget:function(a){var c=a;while(c!=document.body){c=c.parentNode;var b=window.getComputedStyle(c);if(b&&b["overflow-y"]=="auto"){if(c.scrollHeight>c.clientHeight){return c}}}return c},shallowCopy:function(a,b){for(var c in b){try{a[c]=b[c]}catch(d){}}return a},mouseEvents:function(c,b){var a=new MouseEvent(c.type,c.raw);a=this.shallowCopy(a,c.raw);this.traquer.toggleStopPropagation(c,a);b.dispatchEvent(a)},wheelEvents:function(c,b){b=this.getScrollTarget(b);var a=new WheelEvent("wheel",c.raw);a=this.shallowCopy(a,c.raw);b.scrollLeft+=a.deltaX;b.scrollTop+=a.deltaY;b.dispatchEvent(a)},focusEvents:function(d,b){var c=(d.type.indexOf("FocusIn")>-1)?"focus":"blur",e=(d.type.indexOf("FocusIn")>-1)||(d.type.indexOf("FocusOut")>-1);if(e){var a=setTimeout(function(){b.dispatchEvent(new FocusEvent(d.type,b));clearTimeout(a)},1)}if(d.type=="focusin"||d.type=="DOMFocusIn"){b.focus()}if(d.type=="focusout"||d.type=="DOMFocusOut"){b.blur()}b.dispatchEvent(new FocusEvent(c,b))},inputEvents:function(c,b){var d=(typeof InputEvent!="undefined")?InputEvent:Event;var a=new d(c.type,c.raw);a=this.shallowCopy(a,c.raw);if(document.activeElement!=b){b=document.activeElement}b.value=c.value!=undefined?(c.value):"";b.dispatchEvent(a)},keyEvents:function(d,c){var a=new KeyboardEvent(d.type,d.raw);a=this.shallowCopy(a,d.raw);if(document.activeElement!=c){c=document.activeElement}if(c.contentEditable&&d.type=="keypress"&&d.raw.which!=9){var b="";if(d.raw.which==13){c.style.whiteSpace="pre";b="\r\r\n"}else{b=String.fromCharCode(d.raw.which)}c.textContent+=b}c.dispatchEvent(a)},UIEvents:function(c,b){var a=new UIEvent(c.type,c.raw);b.dispatchEvent(a)},event:function(c,b){var a=new Event(c.type,c.raw);b.dispatchEvent(a)}};"use strict";Traquer.Heatmap=function(){if(!(this instanceof Traquer.Heatmap)){return new Traquer.Heatmap()}this.traquer=Traquer.getInstance()};Traquer.Heatmap.prototype.make=function(){var q=this,w=q.traquer,c=Array.prototype.slice.call(w.recordedEvents),e=document.querySelector(".traquer-heatmap");if(!e){e=document.createElement("div");e.className="traquer-heatmap";document.body.appendChild(e);var v=['<div id="traquer-heatmap-close" class="button close">Close</div>','<div id="traquer-heatmap-play" class="button play">Play</div>',].join("");e.innerHTML=v}var d=["#1EE656","#26E553","#2EE550","#37E54D","#3FE54A","#48E547","#50E444","#58E441","#61E43E","#69E43C","#72E439","#7AE336","#82E333","#8BE330","#93E32D","#9CE32A","#A4E227","#ACE225","#B5E222","#BDE21F","#C6E21C","#CEE119","#D6E116","#DFE113","#E7E110","#F0E10E","#F0D811","#F1CF15","#F1C619","#F2BE1D","#F3B521","#F3AC25","#F4A329","#F59B2D","#F59230","#F68934","#F68038","#F7783C","#F86F40","#F86644","#F95D48","#FA554C","#FA4C4F","#FB4353","#FB3A57","#FC315B","#FD295F","#FD2063","#FE1767","#FF0F6B"];var n=[],u,p=0,o=0,l=d[0],z=0,s=2,r=2;c=c.sort(function(k,i){return k.x-i.x||k.y-i.y});for(u in c){if(c.hasOwnProperty(u)){var m=c[u],j=m.x,h=m.y,a,b,g;if(p&&o){a={height:2,width:2,left:p,top:o};b={height:2,width:2,left:j,top:h};g=q.getIntersection(b,a);if(g){z++;s++;r++}else{z=0;s=2;r=2}if(z>d.length-1){z=d.indexOf(d[d.length-1])}l="rgba("+q.hexToRgb(d[z],0.1)+")"}var f=['<div class="traquer-heat-point" style="',"top: "+(h-(r/2))+"px;","left: "+(j-(s/2))+"px;","background: "+l+";","width: "+s+"px;","height: "+r+'px; "></div>'].join("");n.push(f);o=h;p=j}}var t=performance.now();e=w.replaceHtml(e,e.innerHTML+n.join(""));console.log(performance.now()-t);q.bindClose();q.bindPlay()};Traquer.Heatmap.prototype.bindClose=function(){var c=document.querySelector("#traquer-heatmap-close"),b=document.querySelector(".traquer-heatmap"),a=document.querySelector(".traquer-modal");c.addEventListener("click",function(d){document.body.removeChild(b);if(a&&a.parentElement){a.style.cssText="opacity: 1"}})};Traquer.Heatmap.prototype.bindPlay=function(){var b=this,a=b.traquer,c=document.querySelector("#traquer-heatmap-play");c.addEventListener("click",function(d){a.play(a.recordedEvents)})};Traquer.Heatmap.prototype.getIntersection=function(a,c){var b=false;if((a.left<=(c.left+c.width)&&(c.left<=(a.left+a.width)))&&(a.top<=(c.top+c.height))&&(c.top<=(a.top+a.height))){b=true}return b};Traquer.Heatmap.prototype.hexToRgb=function(f,c){f=f.replace("#","");var h=parseInt(f,16);var e=(h>>16)&255;var d=(h>>8)&255;var a=h&255;return e+","+d+","+a+","+c};"use strict";Traquer.Lzw=function(){if(!(this instanceof Traquer.Lzw)){return new Traquer.Lzw()}};Traquer.Lzw.prototype.getHumanReadableLength=function(c){var a=this.getByteLength(c);var b=1024,e=b*b,d=e*b;if(a>d){return Math.round(a*100/d)/100+" GB"}if(a>e){return Math.round(a*100/e)/100+" MB"}return Math.round(a*100/b)/100+" KB"};Traquer.Lzw.prototype.getByteLength=function(c){var a=0;for(var b=0;b<c.length;b++){var d=c.charCodeAt(b);if(d<=127){a+=1}else{if(d<=2047){a+=2}else{if(d>=55296&&d<=57343){a+=4;b++}else{if(d<65535){a+=3}else{a+=4}}}}}return a};Traquer.Lzw.prototype.encode=function(d){d=JSON.stringify(d);var h={};var f=(d+"").split("");var b=[];var g;var a=f[0];var e=256;for(var c=1;c<f.length;c++){g=f[c];if(h[a+g]!=null){a+=g}else{b.push(a.length>1?h[a]:a.charCodeAt(0));h[a+g]=e;e++;a=g}}b.push(a.length>1?h[a]:a.charCodeAt(0));return JSON.stringify(b)};Traquer.Lzw.prototype.decode=function(h){h=JSON.parse(h);var b={};var d=String.fromCharCode(h[0]);var c=d;var g=[d];var a=256;var e;for(var j=1;j<h.length;j++){var f=h[j];if(f<256){e=String.fromCharCode(h[j])}else{e=b[f]?b[f]:(c+d)}g+=e;d=e[0];b[a]=c+d;a++;c=e}return JSON.parse(g)};"use strict";Traquer.Modal=function(a){if(!(this instanceof Traquer.Modal)){return new Traquer.Modal()}this.id="traquer_modal_"+Math.random().toString(36).substring(3).substr(0,8);this.traquer=Traquer.getInstance();if(a){this.closeFn=a.close||function(){}}};Traquer.Modal.prototype.open=function(g,a){var c=this.getTpl(),e=document.querySelector(".traquer-list"),b=document.createElement("div");b.id="modal-container-"+this.id;c=c.replace("{id}",this.id).replace("{title}",g).replace("{body}",a);e.appendChild(b);b.innerHTML=c;var d=document.body.querySelector("#"+this.id),f=d.querySelector(".close");if(f){f.addEventListener("click",this.close.bind(this))}};Traquer.Modal.prototype.close=function(d){var b=document.body.querySelector("#"+this.id),c=document.querySelector(".traquer-list"),a=c.querySelector("#modal-container-"+this.id);c.removeChild(a);this.closeFn()};Traquer.Modal.prototype.getTpl=function(){var a=['<div class="traquer-modal" id="{id}">',' <div class="traquer-modal-content">','   <div class="modal-header">','     <span class="close">Ã—</span>',"     <h2>{title}</h2>","   </div>",'   <div class="modal-body">',"     {body}","   </div>"," </div>","</div>"].join("");return a};"use strict";Traquer.Storage=function(){if(!(this instanceof Traquer.Storage)){return new Traquer.Storage()}this.traquer=Traquer.getInstance();this.lzw=new Traquer.Lzw();this.unit=function(){var a=JSON.stringify(window.location);a=JSON.parse(a);return{location:a,records:undefined,name:undefined,time:undefined}}};Traquer.Storage.prototype.save=function(a){var c=this.unit(),b="traquer_"+Math.random().toString(36).substring(3).substr(0,8);c.records=a;c.name=b;c.time=Date.now();var d=this.lzw.encode(c);console.log(this.lzw.getHumanReadableLength(d));localStorage.setItem(b,d);this.hint()};Traquer.Storage.prototype.remove=function(a){localStorage.removeItem(a)};Traquer.Storage.prototype.hint=function(){var c=this,a=c.traquer,e=a.recordedEvents,f=document.querySelector(".traquer-list"),h=c.getRawList();if(!f){f=document.createElement("div");f.className="traquer-list";document.body.appendChild(f)}var d=["<h3>You have "+h.length+" cases for this page</h3>",'<p id="traquer-show-storage" class="button green">Manage list</p>','<p id="traquer-import-storage" class="button">Import</p>'].join("");if(!h.length){var d=["<h3>You have "+h.length+" cases for this page</h3>",'<p id="traquer-import-storage" class="button green">Import</p>'].join("")}f.innerHTML=d;var b=f.querySelector("#traquer-show-storage"),g=f.querySelector("#traquer-import-storage");b&&b.addEventListener("click",function(i){c.getModal(h)});g&&g.addEventListener("click",function(j){var i=document.createElement("input");i.type="file";i.style.display="none";i.id="traquer-import";i.setAttribute("accept",".json");i.addEventListener("change",function(m){var l=i.files[0],k=new FileReader();k.onload=function(q){var n=q.target.result,o=c.lzw.decode(n);if(!o.location&&!o.time&&!o.records&&!o.name){console.log("[e] invalid format.");return}var p=c.lzw.encode(o);console.log(c.lzw.getHumanReadableLength(p));localStorage.setItem(o.name,p);c.hint()};k.readAsText(l)});j.target.appendChild(i);i=document.querySelector("#traquer-import");i.click()})};Traquer.Storage.prototype.exportCase=function(c){var a="data:application/json;charset=utf-8,"+c,d=new Date().toDateString().replace(/\s/g,"-");var b=document.createElement("a");b.setAttribute("href",encodeURI(a));b.setAttribute("download","traquer_export_data_"+d+".json");document.body.appendChild(b);b.click()};Traquer.Storage.prototype.importCase=function(a){};Traquer.Storage.prototype.serialize=function(b){var a=[].slice.call(b.querySelectorAll("input")),c=[];a.forEach(function(d){if(d.checked){c.push({name:d.name,time:d.getAttribute("time")})}});c=c.sort(function(e,d){return e.time-d.time});return c};Traquer.Storage.prototype.joinRecords=function(f,h){var c=[],b;for(b in f){if(f.hasOwnProperty(b)){var a=f[b].name,e=h.filter(function(i){return i.name==a})[0];if(e){var d=c[c.length-1],g=0;if(d){g=d.time}e.records.forEach(function(i){i.time+=g});c=c.concat(e.records)}}}return c};Traquer.Storage.prototype.getRawList=function(){var a=this,c=[],e=[],b;for(b in localStorage){if(b&&b.indexOf("traquer_")>-1){c.push(b)}}for(b in c){if(c.hasOwnProperty(b)){var d=localStorage.getItem(c[b]);d=a.lzw.decode(d);if(d.location.host==window.location.host&&d.location.port==window.location.port&&d.location.hash==window.location.hash&&d.location.origin==window.location.origin){e.push(d)}}}return e.sort(function(g,f){return f.time-g.time})};Traquer.Storage.prototype.getHTMLList=function(b){var j=this,d=j.traquer,g=[],f;for(f in b){if(b.hasOwnProperty(f)){var h=b[f],c=d.getSimilarity(h.records),e=!isNaN(c)?c<50:true;var a=["<label>","<input "+(e?"disabled":"")+' type="checkbox" name="'+h.name+'" time="'+h.time+'"/>','Case on <span style="color: #925e8b;">'+h.location.href+"</span>, <br/>",' &bull; DOM similarity to current location <span style="color: #28e;">'+c+"%</span>, <br/>",' &bull; Captured event count <span style="color: #28e;">'+h.records.length+"</span>, <br/>",' &bull; Captured time <span style="color: #28e;">'+new Date(h.time)+"</span>."," <br/>&nbsp;","</label>"].join("");g.push(a)}}g.push("</form>");return g.join("")};Traquer.Storage.prototype.getButtons=function(){var a=['<p style="float: right;" id="traquer-storage-run" class="button green">Run selected</p>','<p style="float: right;" id="traquer-storage-delete" class="button red left">Delete selected</p>','<p style="float: right;" id="traquer-storage-heatmap" class="button">Heatmap selected</p>','<p style="float: right;" id="traquer-storage-export" class="button left">Export selected</p>'];return a.join("")};Traquer.Storage.prototype.getModal=function(c){var m=this,f=m.traquer,l=new Traquer.Modal({close:function(){m.hint()}});var j=["<h3>Saved Cases</h3>","<p>Select cases you wish to run.<br/>","Cases with similarity less than 50% to current DOM tree won't be selectable.</p>",'<p style="float:left;" id="traquer-storage-override" class="button">Override similarity restriction</p><p>&nbsp;</p>','<form style="clear:left;" id="traquer-form" class="inner-list">'].join("");var k=m.getHTMLList(c),e=m.getButtons(),i=j+k+e;l.open.call(l,"Manage List",i);var b=document.querySelector("#traquer-storage-run"),h=document.querySelector("#traquer-storage-delete"),d=document.querySelector("#traquer-storage-heatmap"),g=document.querySelector("#traquer-storage-export"),a=document.querySelector("#traquer-storage-override");b.addEventListener("click",function(r){var p=document.querySelector("#"+l.id+" form"),q=m.serialize(p),o=m.joinRecords(q,c);f.recordedEvents=o;var n=Traquer.Controls.getInstance();n.timeline.call(n);n.player.call(n);l.close()});h.addEventListener("click",function(q){var o=document.querySelector("#"+l.id+" form"),n=[].slice.call(o.querySelectorAll("input")),p=[];n.forEach(function(s){if(s.checked){m.remove(s.name)}});var r=m.getHTMLList(m.getRawList());o.innerHTML=r});d.addEventListener("click",function(s){var r=new Traquer.Heatmap(),p=document.querySelector(".traquer-modal");if(p&&p.parentElement){var o=document.querySelector("#"+l.id+" form"),q=m.serialize(o),n=m.joinRecords(q,c);f.recordedEvents=n;if(!f.recordedEvents.length){return}p.style.cssText="opacity: 0.1"}r.make()});g.addEventListener("click",function(t){var q=document.querySelector("#"+l.id+" form"),r=m.serialize(q),o=m.joinRecords(r,c);var p=m.unit(),n="traquer_"+Math.random().toString(36).substring(3).substr(0,8);p.records=o;p.name=n;p.time=Date.now();var s=m.lzw.encode(p);console.log(m.lzw.getHumanReadableLength(s));m.exportCase(s)});a.addEventListener("click",function(p){var o=document.querySelector("#"+l.id+" form"),n=[].slice.call(o.querySelectorAll("input"));n.forEach(function(q){q.removeAttribute("disabled")});p.target.parentElement.removeChild(p.target)})};document.addEventListener("DOMContentLoaded",function(){var c=document.createElement("div");c.className="traquer-recorder";c.id="traquer-recorder";c.title="Record";var a=new Traquer(),b=new Traquer.Controls(),d=new Traquer.Storage();a.config={host:window.location.origin};b.loadStyles();c.addEventListener("click",b.recording.bind(this,b));document.body.appendChild(c);d.hint()});window.addEventListener("hashchange",function(){var a=new Traquer.Storage();a.hint()});