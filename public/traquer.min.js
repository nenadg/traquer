"use strict";var Traquer=function(){if(!(this instanceof Traquer)){return new Traquer()}this.index=0;this.logging=false;this.recordedEvents=[];this.previousElement=null;this.domWatchCounter=0;this.eventNames=["mousemove","mouseenter","mouseleave","mouseover","mousedown","mouseup","mouseout","click","scroll","contextmenu","wheel","focus","focusin","focusout","change","input","textinput","keypress","keydown","keyup","DOMFocusIn","DOMFocusOut","selectstart","selectionchange","select","DOMActivate"];var a=document.querySelector(".traquer-base");if(!a){a=document.createElement("div");a.className="traquer-base";document.body.appendChild(a);window.onerror=function(d,c,b){var e=new Event("traquerfail");e.details=[d,c,b];a.dispatchEvent(e)};a.addEventListener("traquerfail",function(b){console.log("[e] Event execution failed.");console.log(b)});a.addEventListener("traquerwarn",function(b){console.warn("[e] Event execution warning.");console.log(b)})}Traquer.__instance=this};Traquer.getInstance=function(){return this.__instance};Traquer.prototype={getId:function(){var b=this.recordedEvents;if(b&&b.length){var a="e_"+Math.random().toString(36).substring(3).substr(0,8),c=b.filter(function(d){if(d.tid==a){return c}});if(c.length){this.getId()}else{return a}}},isEventObservable:function(a){if(a&&a.type){return this.eventNames.indexOf(a.type)>-1}return false},start:function(b){var a=this;a.isRecording=true;a.recordingStartTime=new Date().getTime();a.recordedEvents=[];a.mousePosition={x:0,y:0};var c=a.eventNames||[];a.processEventBinded=a.processEvent.bind(a);c.forEach(function(d){document.body.addEventListener(d,a.processEventBinded,false)});document.addEventListener("mousemove",function(d){a.mousePosition.x=d.clientX;a.mousePosition.y=d.clientY});document.addEventListener("DOMSubtreeModified",a.domWatch);if(b){this.logging=true}},stop:function(){var a=this;var c=a.eventNames||[];if(a.processEventBinded){c.forEach(function(d){document.body.removeEventListener(d,a.processEventBinded,false)})}a.isRecording=false;if(a.playerTarget){var b=new Event("stop");a.playerTarget.dispatchEvent(b)}document.removeEventListener("DOMSubtreeModified",a.domWatch,false);return this.recordedEvents},copyEventObject:function(a){var d={};for(var b in a){var c=typeof a[b];if(c!="function"&&c!="object"){d[b]=a[b]}}return d},createTrackingObject:function(a){var b=this;return{tid:b.getId(),index:b.index,x:b.mousePosition.x,y:b.mousePosition.y,time:new Date().getTime()-b.recordingStartTime,raw:b.copyEventObject(a),type:a.type,id:a.target.id,targetType:a.target.tagName?a.target.tagName.toLowerCase():null,value:a.target.value||a.target.text,attrs:(function(){return b.getAttributes(a.target)})(),classList:(function(){return b.getClassess(a.target)})()}},processEvent:function(a){var c=this;if(a.type=="mousedown"){c.isMouseDown=true}if(c.isEventObservable(a)||c.isMouseDown){var b=c.createTrackingObject(a);if(b.id!="traquer-recorder"){b.selector=c.createSelector.call(b,c);if(document.querySelectorAll(b.selector)){delete b.classList;delete b.attrs;c.domWatchCounter=0;c.recordedEvents.push(b);this.index++;if(this.logging){console.log(b)}}}}if(a.type=="mouseup"){c.isMouseDown=false}},eventsScheduler:function(){var c=this;if(c.eventsInfo&&c.eventsEmitted<c.eventsInfo.length){var e=c.eventsInfo[this.eventsEmitted];var b=c.eventsInfo[this.eventsEmitted-1];var a=b?e.time-b.time:e.time;var d=setTimeout(function(){c.eventEmitter(e);c.eventsEmitted++;c.eventsScheduler();clearTimeout(d)},a)}else{c.isPlaying=false;c.removeFakeCursor()}},play:function(b){if(this.isPlaying){return}var a=this.getSimilarity(b);if(a<50){console.warn("[w] Current scenario is less than 50% similar to page you`re testing ("+a+")")}this.isPlaying=true;this.createFakeCursor();this.eventsEmitted=0;this.eventsInfo=b;this.eventsScheduler()},domWatch:function(a){var c=Traquer.getInstance(),b=c.createTrackingObject(a);if(c.domWatchCounter>100){delete b.classList;delete b.attrs;c.domWatchCounter=0;c.recordedEvents.push(b)}else{c.domWatchCounter++}},eventEmitter:function(j){var m=this;if(j){var f=document.querySelector(j.selector),k=f?f:document.elementFromPoint(j.x,j.y),i=m.getFakeCursor(),l=new Traquer.EventBase(m);i.style.top=j.y+"px";i.style.left=j.x+"px";if(!f){console.warn("[f] Cant find element by current selector, probably not there.",j.selector);return}console.log(j.selector);if(!this.previousElement){this.previousElement=k.parentElement}else{var b=this.matchChild(this.previousElement,k);var e=this.getOffset(this.previousElement);var c=this.getOffset(k);var h={x1:e.x,x2:e.x+e.w,y1:e.y,y2:e.y+e.h};var d=this.pointRectangleIntersection(c,h);if(d||b){j.stopPropagationFlag=true}this.previousElement=null}var g;switch(j.type){case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mousedown":case"mouseup":case"mouseout":case"click":case"dblclick":case"contextmenu":l.mouseEvents(j,k);break;case"wheel":l.wheelEvents(j,k);break;case"DOMFocusIn":case"DOMFocusOut":case"focusin":case"focus":case"focusout":case"blur":l.focusEvents(j,k);break;case"beforeinput":case"input":case"textinput":l.inputEvents(j,k);break;case"keypress":case"keydown":case"keyup":case"nothing":l.keyEvents(j,k);break;case"change":l.event(j,k);break;case"selectstart":case"selectionchange":l.focusEvents(j,k);break;case"scroll":case"select":case"DOMMouseScroll":case"DOMActivate":case"DOMSubtreeModified":case"DOMCharacterDataModified":l.UIEvents(j,k);break}if(m.trackTarget){var a=new CustomEvent("move",{detail:{eventInfo:j,last:m.recordedEvents[m.recordedEvents.length-1].time}});m.trackTarget.dispatchEvent(a)}}if(m.recordedEvents.indexOf(j)==m.recordedEvents.length-1){m.stop()}},getFakeCursor:function(){return this.fakeCursor||this.createFakeCursor()},createFakeCursor:function(){this.fakeCursor=document.createElement("div");this.fakeCursor.style.height="10px";this.fakeCursor.style.width="10px";this.fakeCursor.style.background="red";this.fakeCursor.style.opacity="0.5";this.fakeCursor.style.display="block";this.fakeCursor.style.position="fixed";this.fakeCursor.style.borderRadius="10px";this.fakeCursor.style.zIndex="2147483647";document.body.appendChild(this.fakeCursor)},removeFakeCursor:function(){if(this.fakeCursor){document.body.removeChild(this.fakeCursor);delete this.fakeCursor}},toggleStopPropagation:function(c,a){var b=["mouseover","mouseenter","mouseleave","mouseout"];if(c.stopPropagationFlag&&b.indexOf(c.type)>-1){a.stopPropagation()}},getAttributes:function(d){var a=[],c;for(c in d.attributes){if(d.attributes.hasOwnProperty(c)){if(d.attributes[c].name!=="style"&&d.attributes[c].value){var h=d.attributes[c].value.match(/<.*?[\s\S]*?>[\s\S]*?<\/.*>/g),e=d.attributes[c].value.match(/(http:).*/g),b=d.attributes[c].name.match(/data-.*/g),g=d.attributes[c].name=="id";if(!g&&(h==null)&&(e==null)&&(b==null)){var f=d.attributes[c].name+'="'+d.attributes[c].value+'"';a.push(f)}}}}return a},getClassess:function(c){var b=[],a;for(a in c.classList){if(c.classList.hasOwnProperty(a)){b.push(c.classList[a])}}return b},getSelector:function(a,f,e,g){var c="";if(a.length>0){var b;for(b in a){if(a.hasOwnProperty(b)){if(a[b]==="value"){c+="["+a[b]+'="'+e+'"]'}else{if(a[b]!==undefined){var d=a[b].match(/class/g)||a[b].match(/selected/g)||a[b].match(/over/g)||a[b].match(/dirty/g)||a[b].match(/selectable/g)||a[b].match(/href/g)||a[b].match(/valign/g)||a[b].match(/role/g)||a[b].match(/tabindex/g);if(!d){c+="["+a[b]+"]"}}}}}}if(f.length>0){var b;for(b in f){if(f.hasOwnProperty(b)){var d=f[b].match(/selected/g)||f[b].match(/over/g)||f[b].match(/dirty/g)||f[b].match(/selectable/g)||f[b].match(/focused/g)||f[b].match(/focus/g);if(!d){c+="."+f[b]}}}}if(g){c+="#"+g}return c},createSelector:function(f){var p=this,d=p.targetType+f.getSelector(p.attrs,p.classList,p.value,p.id),m=document.querySelector(d),h=document.querySelectorAll(d),c=[],k;if(h.length>1){var j;for(j in h){if(h.hasOwnProperty(j)){var l=h[j],b;var o=l.getBoundingClientRect(),n={height:10,left:f.mousePosition.x,top:f.mousePosition.y,width:10};b=f.getIntersection(l,n);if(b){while(l!=document.body){var g=f.getAttributes(l),e=f.getClassess(l);if(g.length&&e.length){c.push(f.getSelector(g,e,l.value,l.id))}if(l.parentElement){l=l.parentNode}}}}}}c=c.reverse();var a="body ";for(var j in c){if(c.hasOwnProperty(j)){var q=c[j];a+=" "+q;var l=document.querySelector(a);if(l){var g=f.getAttributes(l),e=f.getClassess(l);d=f.getSelector(g,e,l.value,l.id)}else{console.log(q)}}}return d},getIntersection:function(e,a){var d=e.getBoundingClientRect();var c=a.getBoundingClientRect?a.getBoundingClientRect():a;var b=false;if((d.left<=(c.left+c.width)&&(c.left<=(d.left+d.width)))&&(d.top<=(c.top+c.height))&&(c.top<=(d.top+d.height))){b=true}return b},getOffset:function(d){var f=d.getBoundingClientRect(),a=f.left,e=f.top,b=f.width,c=f.height;return{x:a,y:e,w:b,h:c}},pointRectangleIntersection:function(b,a){return b.x>a.x1&&b.x<a.x2&&b.y>a.y1&&b.y<a.y2},matchChild:function(b,e){var c=false,a;if(b&&b.childNodes){for(a in b.childNodes){if(b.childNodes.hasOwnProperty(a)){var d=b.childNodes[a];if(d==e){return true}else{this.matchChild(d,e)}}}}return c},getSimilarity:function(c){var a=0,j=0,d=false,f;for(f in c){if(c.hasOwnProperty(f)){var h=c[f],e=document.querySelector(h.selector);if(h.type=="DOMSubtreeModified"){d=!d}if(d){a++;continue}if(e&&!d){var b=window.getComputedStyle(e),g=b.visibility=="hidden";if(!g){a++}}}}j=(a/c.length)*100;return Math.round(j*100)/100}};"use strict";Traquer.Controls=function(){if(!(this instanceof Traquer.Controls)){return new Traquer.Controls()}this.traquer=Traquer.getInstance();this.styles=["base.css","timeline.css","recorder.css","player.css","reset.css","track.css","editor.css","storage.css","modal.css"];Traquer.Controls.__instance=this};Traquer.Controls.getInstance=function(){return this.__instance};Traquer.Controls.prototype.loadStyles=function(){var a=this,e=document.head,g=e.querySelectorAll("link"),b=false,d;for(d in g){if(g.hasOwnProperty(d)){var f=g[d];if(a.styles.indexOf(f.href)>-1){b=true}}}if(!b){console.warn("[i] load min styles.");var c=document.createElement("link");c.rel="stylesheet";c.type="text/css";c.href="http://localhost:3008/traquer.min.css";document.head.appendChild(c)}};Traquer.Controls.prototype.recording=function(d,g){var c=d,a=c.traquer,b=g.target,f=document.querySelector(".traquer-player");if(!a.isRecording){a.start();b.className="traquer-recorder squared";return}if(f){document.body.removeChild(f)}b.className="traquer-recorder";a.stop();var h=new Traquer.Storage();h.save(a.recordedEvents);c.timeline.call(c);c.player.call(c)};Traquer.Controls.prototype.timeline=function(){var t=this,C=t.traquer,b=C.recordedEvents,a=document.querySelector("ol.traquer-timeline-container");if(!a){a=document.createElement("ol");a.className="traquer-timeline-container";document.body.appendChild(a)}a.innerHTML="";if(!b.length){return}var k=a.getBoundingClientRect(),n=k.width,l=b[b.length-1].time;t.tlcWidth=n;var D=2147000000,E=[],h="",d,x;for(x in b){if(b.hasOwnProperty(x)){var w=b[x],B=parseInt(w.time/l*100),e=parseInt(B*n/100),s=w.tid,z=['<li id="'+s+'"',' style="left: '+e+'px;"',' class="{css-class}">','<div class="tl-type" style="z-index: '+(D++)+'">',"{title} {key} ","</div>",'<div class="tl-selector" style="z-index: '+(D++)+'">',"{selector}","</div>","</li>"].join("");var m=w.type=="click"||w.type=="keydown"||w.type=="keyup"||w.type=="keypress"?"red":w.type.indexOf("DOM")>-1?"blue":w.type.indexOf("select")>-1?"green":"default";z=z.replace(/{title}/igm,w.type).replace(/{selector}/igm,w.selector).replace(/{key}/igm,w.raw.key||"").replace(/{css-class}/igm,m);var c={id:s,time:w.time,type:w.type,lastTimeLine:e,selector:w.selector};E.push(c);h+=z}}a.innerHTML=h;for(x in E){if(E.hasOwnProperty(x)){var c=E[x],f=c.type,u=c.id,j=c.time,v=c.selector,B=parseInt(j/l*100),e=parseInt(B*n/100),o=a.querySelector("#"+u);if(d&&(e>d-10&&e<d+10)){var y=o.previousSibling;if(!y){continue}var p=window.getComputedStyle(o),A=window.getComputedStyle(y),g=Math.abs(Math.round(parseFloat(p.top.replace("px",""))*100/100)),r=Math.abs(Math.round(parseFloat(A.top.replace("px",""))*100/100)),q=0;if((f=="click"||f=="keydown"||f=="keyup"||f=="keypress"||f.indexOf("DOM")>-1||f.indexOf("select")>-1)){if(r==g){q=g+8}if(r>g){q=r-g+4}if(r<g){q=g-r+4}q=-q;q+="px"}else{if(r==g){q=g+18}if(r>g){q=r-g+38}if(r<g){q=g-r+38}q-=70;q+="px"}o.style.cssText+="top: "+q+";"}o.addEventListener("click",function(F,N,I,J,M){var H=this.recordedEvents.filter(function(i){return i.tid==F})[0];var O=M.target,G=O.parentNode.querySelectorAll(".selected"),L;for(L in G){if(G.hasOwnProperty(L)){var K=G[L];K.className=K.className.replace("selected","")}}if(O.className.indexOf("selected")==-1){O.className+=" selected"}else{O.className=O.className.replace("selected","")}t.editor(F,N,I,J)}.bind(C,u,f,j,v));d=c.lastTimeLine}}};Traquer.Controls.prototype.player=function(){var b=this,a=b.traquer,e=a.recordedEvents,f=document.querySelector("ol.traquer-timeline-container"),d=document.querySelector(".traquer-timeline-track"),c=document.querySelector(".traquer-player");if(!c){c=document.createElement("div");c.className="traquer-player";c.title="Replay";document.body.appendChild(c);c.innerHTML='<div class="play"></div>';a.playerTarget=c;c.addEventListener("stop",function(g){c.className="traquer-player"});c.addEventListener("click",function(h,j){var g=this;if(!g.isPlaying){c.className+=" playing";g.play(h);var i=document.querySelector(".traquer-editor");if(i){document.body.removeChild(i)}return}g.stop();c.className="traquer-player"}.bind(a,e))}this.reset();if(!d){d=document.createElement("div");d.className="traquer-timeline-track";document.body.appendChild(d);d.innerHTML=['<div class="current-event">',"</div>"].join("");a.trackTarget=d;d.addEventListener("move",function(m){var k=m.detail.eventInfo,j=m.detail.last,l=k.time,g=b.tlcWidth,i=document.querySelector(".current-event");var n=parseInt(l/j*100),h=parseInt(n*g/100)+152;m.target.style.cssText="left: "+h+"px;";if(b.previousTime>l-2&&b.previousTime<l+2){i.innerHTML+=k.type+"("+l+") <br />"}else{i.innerHTML=k.type+"("+l+") <br />"}b.previousTime=l})}};Traquer.Controls.prototype.reset=function(){var b=this,a=b.traquer,c=a.recordedEvents,d=document.querySelector(".traquer-reset");if(!d){d=document.createElement("div");d.className="traquer-reset";d.title="Reset";document.body.appendChild(d);d.innerHTML='<div class="play"></div>';d.addEventListener("click",function(j,l){var f=this,m=document.querySelector("ol.traquer-timeline-container"),i=document.querySelector(".traquer-timeline-track"),h=document.querySelector(".current-event"),g=document.querySelector(".traquer-player"),k=document.querySelector(".traquer-editor");f.recordedEvents=[];document.body.removeChild(g);document.body.removeChild(d);document.body.removeChild(m);document.body.removeChild(i);if(k){document.body.removeChild(k)}}.bind(a,c))}};Traquer.Controls.prototype.editor=function(a,g,b,c){var i=this,d=i.traquer,h=d.recordedEvents,f=document.querySelector(".traquer-editor");if(!f){f=document.createElement("div");f.className="traquer-editor";document.body.appendChild(f)}var e=['<h3>Event `<span id="event-type-'+a+'">'+g+"</span>`</h3>",'<span id="editor-close" class="close">x</span>',"<p>Event executed at "+b+"ms from start.</p>","<p>Selector:<br/>",'<i id="event-selector-'+a+'" class="selector">'+c+"</i>","</p>",'<p id="delete-event-'+a+'" class="button red">Delete event</p>','<p id="edit-event-'+a+'" class="button">Edit event</p>'].join("");f.innerHTML="";f.innerHTML=e;this.bindDelete(f.querySelector("#delete-event-"+a),a);this.bindEdit(f.querySelector("#edit-event-"+a),a);this.bindClose(f.querySelector("#editor-close"))};Traquer.Controls.prototype.bindClose=function(b){var a=this;b.addEventListener("click",function(d){var c=document.querySelector(".traquer-editor");document.body.removeChild(c);a.timeline.call(a)})};Traquer.Controls.prototype.bindDelete=function(d,e){var b=this,a=b.traquer,c=a.recordedEvents;d.addEventListener("click",function(h){var f=c.filter(function(i){return i.tid==e})[0],g=document.querySelector(".traquer-editor");c.splice(c.indexOf(f),1);b.timeline.call(b);document.body.removeChild(g)})};Traquer.Controls.prototype.bindEdit=function(b,c){var a=this;b.addEventListener("click",a.editFn.bind(a,b,c))};Traquer.Controls.prototype.editFn=function(c,a,j){var m=this,g=m.traquer,l=g.recordedEvents,b=l.filter(function(e){return e.tid==a})[0],h=document.querySelector(".traquer-editor"),d=document.querySelector("#delete-event-"+a),f=document.querySelector("#event-type-"+a),i=document.querySelector("#event-selector-"+a);c.removeEventListener("click",m.editFn,false);if(d){h.removeChild(d)}f.setAttribute("contentEditable",true);i.setAttribute("contentEditable",true);var k=c.cloneNode();k.id="save-event-"+a;k.innerText="Save";k.className+=" green";k.addEventListener("click",m.saveFn.bind(m,c,a));h.replaceChild(k,c)};Traquer.Controls.prototype.saveFn=function(c,b,j){var m=this,h=m.traquer,l=h.recordedEvents,f=document.querySelector("#event-type-"+b),k=document.querySelector("#event-selector-"+b),i=document.querySelector(".traquer-editor"),a=l.filter(function(e){return e.tid==b})[0],d=f.innerText,g=k.innerText;a.type=d&&d.length?d.replace(/\s/g,""):a.type;a.selector=g&&g.length?g:a.selector;l[l.indexOf(a)]=a;m.timeline.call(m);document.body.removeChild(i)};"use strict";Traquer.EventBase=function(a){if(!(this instanceof Traquer.EventBase)){return new Traquer.EventBase()}if(!a||!(a instanceof Traquer)){throw new Error("Can't instantiate EventBase without Traquer instance!")}this.traquer=a};Traquer.EventBase.prototype={getScrollTarget:function(a){var c=a;while(c!=document.body){c=c.parentNode;var b=window.getComputedStyle(c);if(b&&b["overflow-y"]=="auto"){if(c.scrollHeight>c.clientHeight){return c}}}return c},shallowCopy:function(a,b){for(var c in b){try{a[c]=b[c]}catch(d){}}return a},mouseEvents:function(c,b){var a=new MouseEvent(c.type,c.raw);a=this.shallowCopy(a,c.raw);this.traquer.toggleStopPropagation(c,a);b.dispatchEvent(a)},wheelEvents:function(c,b){b=this.getScrollTarget(b);var a=new WheelEvent("wheel",c.raw);a=this.shallowCopy(a,c.raw);b.scrollLeft+=a.deltaX;b.scrollTop+=a.deltaY;b.dispatchEvent(a)},focusEvents:function(d,b){var c=(d.type.indexOf("FocusIn")>-1)?"focus":"blur",e=(d.type.indexOf("FocusIn")>-1)||(d.type.indexOf("FocusOut")>-1);if(e){var a=setTimeout(function(){b.dispatchEvent(new FocusEvent(d.type,b));clearTimeout(a)},1)}if(d.type=="focusin"||d.type=="DOMFocusIn"){b.focus()}if(d.type=="focusout"||d.type=="DOMFocusOut"){b.blur()}b.dispatchEvent(new FocusEvent(c,b))},inputEvents:function(c,b){var d=(typeof InputEvent!="undefined")?InputEvent:Event;var a=new d(c.type,c.raw);a=this.shallowCopy(a,c.raw);if(document.activeElement!=b){b=document.activeElement}b.value=c.value!=undefined?(c.value):"";b.dispatchEvent(a)},keyEvents:function(d,c){var a=new KeyboardEvent(d.type,d.raw);a=this.shallowCopy(a,d.raw);if(document.activeElement!=c){c=document.activeElement}if(c.contentEditable&&d.type=="keypress"&&d.raw.which!=9){var b="";if(d.raw.which==13){c.style.whiteSpace="pre";b="\r\r\n"}else{b=String.fromCharCode(d.raw.which)}c.textContent+=b}c.dispatchEvent(a)},UIEvents:function(c,b){var a=new UIEvent(c.type,c.raw);b.dispatchEvent(a)},event:function(c,b){var a=new Event(c.type,c.raw);b.dispatchEvent(a)}};"use strict";Traquer.Lzw=function(){if(!(this instanceof Traquer.Lzw)){return new Traquer.Lzw()}};Traquer.Lzw.prototype.getHumanReadableLength=function(c){var a=this.getByteLength(c);var b=1024,e=b*b,d=e*b;if(a>d){return Math.round(a*100/d)/100+" GB"}if(a>e){return Math.round(a*100/e)/100+" MB"}return Math.round(a*100/b)/100+" KB"};Traquer.Lzw.prototype.getByteLength=function(c){var a=0;for(var b=0;b<c.length;b++){var d=c.charCodeAt(b);if(d<=127){a+=1}else{if(d<=2047){a+=2}else{if(d>=55296&&d<=57343){a+=4;b++}else{if(d<65535){a+=3}else{a+=4}}}}}return a};Traquer.Lzw.prototype.encode=function(d){d=JSON.stringify(d);var h={};var f=(d+"").split("");var b=[];var g;var a=f[0];var e=256;for(var c=1;c<f.length;c++){g=f[c];if(h[a+g]!=null){a+=g}else{b.push(a.length>1?h[a]:a.charCodeAt(0));h[a+g]=e;e++;a=g}}b.push(a.length>1?h[a]:a.charCodeAt(0));return JSON.stringify(b)};Traquer.Lzw.prototype.decode=function(h){h=JSON.parse(h);var b={};var d=String.fromCharCode(h[0]);var c=d;var g=[d];var a=256;var e;for(var j=1;j<h.length;j++){var f=h[j];if(f<256){e=String.fromCharCode(h[j])}else{e=b[f]?b[f]:(c+d)}g+=e;d=e[0];b[a]=c+d;a++;c=e}return JSON.parse(g)};"use strict";Traquer.Modal=function(a){if(!(this instanceof Traquer.Modal)){return new Traquer.Modal()}this.id="traquer_modal_"+Math.random().toString(36).substring(3).substr(0,8);this.traquer=Traquer.getInstance();if(a){this.closeFn=a.close||function(){}}};Traquer.Modal.prototype.open=function(g,a){var c=this.getTpl(),e=document.querySelector(".traquer-list"),b=document.createElement("div");b.id="modal-container-"+this.id;c=c.replace("{id}",this.id).replace("{title}",g).replace("{body}",a);e.appendChild(b);b.innerHTML=c;var d=document.body.querySelector("#"+this.id),f=d.querySelector(".close");if(f){f.addEventListener("click",this.close.bind(this))}};Traquer.Modal.prototype.close=function(d){var b=document.body.querySelector("#"+this.id),c=document.querySelector(".traquer-list"),a=c.querySelector("#modal-container-"+this.id);c.removeChild(a);this.closeFn()};Traquer.Modal.prototype.getTpl=function(){var a=['<div class="traquer-modal" id="{id}">',' <div class="traquer-modal-content">','   <div class="modal-header">','     <span class="close">Ã—</span>',"     <h2>{title}</h2>","   </div>",'   <div class="modal-body">',"     {body}","   </div>"," </div>","</div>"].join("");return a};"use strict";Traquer.Storage=function(){if(!(this instanceof Traquer.Storage)){return new Traquer.Storage()}this.traquer=Traquer.getInstance();this.lzw=new Traquer.Lzw();this.unit=function(){var a=JSON.stringify(window.location);a=JSON.parse(a);return{location:location,records:undefined,name:undefined,time:undefined}}};Traquer.Storage.prototype.save=function(a){var c=this.unit(),b="traquer_"+Math.random().toString(36).substring(3).substr(0,8);c.records=a;c.name=b;c.time=Date.now();var d=this.lzw.encode(c);console.log(this.lzw.getHumanReadableLength(d));localStorage.setItem(b,d);this.hint()};Traquer.Storage.prototype.remove=function(a){localStorage.removeItem(a)};Traquer.Storage.prototype.getRawList=function(){var a=this,c=[],e=[],b;for(b in localStorage){if(b&&b.indexOf("traquer_")>-1){c.push(b)}}for(b in c){if(c.hasOwnProperty(b)){var d=localStorage.getItem(c[b]);d=a.lzw.decode(d);if(d.location.href==window.location.href&&d.location.pathname==window.location.pathname&&d.location.hash==window.location.hash){e.push(d)}}}return e.sort(function(g,f){return f.time-g.time})};Traquer.Storage.prototype.getHTMLList=function(b){var j=this,d=j.traquer,g=[],f;for(f in b){if(b.hasOwnProperty(f)){var h=b[f],c=d.getSimilarity(h.records),e=!isNaN(c)?c<50:true;var a=["<label>","<input "+(e?"disabled":"")+' type="checkbox" name="'+h.name+'" time="'+h.time+'"/>','Case on <span style="color: #925e8b;">'+h.location.href+"</span>, <br/>",' &bull; DOM similarity to current location <span style="color: #28e;">'+c+"%</span>, <br/>",' &bull; Captured event count <span style="color: #28e;">'+h.records.length+"</span>, <br/>",' &bull; Captured time <span style="color: #28e;">'+new Date(h.time)+"</span>."," <br/>&nbsp;","</label>"].join("");g.push(a)}}g.push("</form>");return g.join("")};Traquer.Storage.prototype.getButtons=function(){var a=['<p style="float: right;" id="traquer-storage-run" class="button">Run selected</p>','<p style="float: right;" id="traquer-storage-delete" class="button red">Delete selected</p>'];return a.join("")};Traquer.Storage.prototype.getModal=function(c){var k=this,e=k.traquer,j=new Traquer.Modal({close:function(){k.hint()}});var h=["<h3>Saved Cases</h3>","<p>Select cases you wish to run.<br/>","Cases with similarity less than 50% to current DOM tree won't be selectable.</p>",'<p style="float:left;" id="traquer-storage-override" class="button">Override similarity restriction</p><p>&nbsp;</p>','<form style="clear:left;" id="traquer-form" class="inner-list">'].join("");var i=k.getHTMLList(c),d=k.getButtons(),g=h+i+d;j.open.call(j,"Manage List",g);var b=document.querySelector("#traquer-storage-run"),f=document.querySelector("#traquer-storage-delete"),a=document.querySelector("#traquer-storage-override");b.addEventListener("click",function(r){var m=document.querySelector("#"+j.id+" form"),q=[].slice.call(m.querySelectorAll("input")),o=[];q.forEach(function(w){if(w.checked){o.push({name:w.name,time:w.getAttribute("time")})}});o=o.sort(function(x,w){return x.time-w.time});var v=[],p;for(p in o){if(o.hasOwnProperty(p)){var l=o[p].name,s=c.filter(function(w){return w.name==l})[0];if(s){var u=v[v.length-1],n=0;if(u){n=u.time}s.records.forEach(function(w){w.time+=n});v=v.concat(s.records)}}}e.recordedEvents=v;var t=Traquer.Controls.getInstance();t.timeline.call(t);t.player.call(t);j.close()});f.addEventListener("click",function(o){var m=document.querySelector("#"+j.id+" form"),l=[].slice.call(m.querySelectorAll("input")),n=[];l.forEach(function(q){if(q.checked){k.remove(q.name)}});var p=k.getHTMLList(k.getRawList());m.innerHTML=p});a.addEventListener("click",function(n){var m=document.querySelector("#"+j.id+" form"),l=[].slice.call(m.querySelectorAll("input"));l.forEach(function(o){o.removeAttribute("disabled")});n.target.parentElement.removeChild(n.target)})};Traquer.Storage.prototype.hint=function(){var c=this,a=c.traquer,e=a.recordedEvents,f=document.querySelector(".traquer-list"),g=c.getRawList();if(!f){f=document.createElement("div");f.className="traquer-list";document.body.appendChild(f)}if(!g.length){document.body.removeChild(f);return}var d=["<h3>You have "+g.length+" cases for this page</h3>",'<p id="traquer-show-storage" class="button">Manage list</p>'].join("");f.innerHTML=d;var b=f.querySelector("#traquer-show-storage");b.addEventListener("click",function(h){c.getModal(g)})};document.addEventListener("DOMContentLoaded",function(){var c=document.createElement("div");c.className="traquer-recorder";c.id="traquer-recorder";c.title="Record";var a=new Traquer(),b=new Traquer.Controls(),d=new Traquer.Storage();b.loadStyles();c.addEventListener("click",b.recording.bind(this,b));document.body.appendChild(c);d.hint()});window.addEventListener("hashchange",function(){var a=new Traquer.Storage();a.hint()});